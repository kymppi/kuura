---
const { serviceId } = Astro.params;
---

<div id="service-root" data-service-id={serviceId}></div>

<script>
  function redirectToLogin() {
    const currentUrl = encodeURIComponent(window.location.pathname);
    window.location.href = `/login?return_to=${currentUrl}`;
  }

  function loginToService(serviceId: string) {
    console.log(`Logging in to service: ${serviceId}`);
  }

  async function checkAuthenticated() {
    const root = document.getElementById('service-root');
    if (!root || !root.dataset.serviceId) {
      redirectToLogin();
      return;
    }

    const serviceId = root.dataset.serviceId;

    try {
      const response = await fetch('/v1/me', {
        credentials: 'include',
      });

      if (response.status === 200) {
        loginToService(serviceId);
      } else if (response.status === 401) {
        redirectToLogin();
      } else {
        console.error(`Unexpected status: ${response.status}`);
      }
    } catch (error) {
      console.error('Error checking auth:', error);
      redirectToLogin();
    }
  }

  window.addEventListener('DOMContentLoaded', checkAuthenticated);
</script>
